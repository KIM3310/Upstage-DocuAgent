<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="google-adsense-account" content="ca-pub-4973160293737562">
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4973160293737562"
       crossorigin="anonymous"></script>
<meta name="description" content="DocuAgent analyzes documents and generates structured learning assets for operational teams.">
<meta name="robots" content="index,follow">
<meta property="og:title" content="DocuAgent — Upstage 문서 분석">
<meta property="og:description" content="문서 분석, 교육 콘텐츠 생성, 운영 실무 적용까지 연결하는 서비스">
<meta property="og:type" content="website">
<title>DocuAgent — Upstage 문서 분석</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Sora:wght@400;600;700&display=swap');
:root {
  --bg: #0b0c13;
  --bg2: #121326;
  --surface: rgba(18, 19, 33, 0.85);
  --surface2: rgba(26, 27, 47, 0.9);
  --surface3: rgba(32, 34, 60, 0.9);
  --border: rgba(150, 140, 210, 0.22);
  --text: #e9e6f7;
  --text2: #a3a0b8;
  --accent: #8b7aff;
  --accent-strong: #6f5bff;
  --accent2: #c1b5ff;
  --glow: rgba(139, 122, 255, 0.35);
  --green: #3dd6b3;
  --orange: #f3b87a;
  --red: #f08080;
  --shadow: 0 14px 30px rgba(7, 8, 18, 0.5);
}
* { margin:0; padding:0; box-sizing:border-box; }
body {
  font-family:'Pretendard','Apple SD Gothic Neo','Noto Sans KR',sans-serif;
  background:
    radial-gradient(1200px 600px at 10% -10%, rgba(139, 122, 255, 0.18), transparent 60%),
    radial-gradient(900px 520px at 95% 0%, rgba(243, 184, 122, 0.08), transparent 55%),
    linear-gradient(160deg, var(--bg) 0%, #0d0f1f 60%, var(--bg2) 100%);
  color:var(--text);
  min-height:100vh;
  position:relative;
  overflow-x:hidden;
  background-attachment:fixed;
}
body::before,
body::after {
  content:'';
  position:fixed;
  pointer-events:none;
  z-index:0;
  filter:blur(28px);
}
body::before {
  top:-15%;
  left:-10%;
  width:58vmax;
  height:58vmax;
  background:radial-gradient(circle, rgba(139, 122, 255, 0.18), transparent 60%);
  opacity:0.8;
}
body::after {
  bottom:-20%;
  right:-10%;
  width:62vmax;
  height:62vmax;
  background:radial-gradient(circle, rgba(193, 181, 255, 0.15), transparent 60%);
  opacity:0.7;
}
::selection { background:rgba(139, 122, 255, 0.35); color:#fff; }

.header {
  padding:20px 32px;
  border-bottom:1px solid var(--border);
  display:flex; align-items:center; gap:16px;
  background:rgba(14, 15, 28, 0.75);
  backdrop-filter:blur(10px);
  box-shadow:0 8px 20px rgba(7, 8, 18, 0.35);
  position:relative;
  z-index:2;
}
.brand {
  display:flex; align-items:center; gap:12px;
}
.brand-logo {
  height:28px; width:auto; max-width:120px;
  object-fit:contain;
  filter:drop-shadow(0 4px 8px rgba(0,0,0,0.25));
}
.brand-text {
  display:flex; flex-direction:column; line-height:1.2;
}
.brand-sub {
  font-size:12px; color:var(--text);
  font-weight:600;
}
.header h1 {
  font-size:20px;
  font-weight:700;
  letter-spacing:0.2px;
  font-family:'Sora','Pretendard',sans-serif;
}
.header h1 span {
  background:linear-gradient(135deg, #cbbfff 0%, #8b7aff 45%, #f2c08a 100%);
  -webkit-background-clip:text;
  background-clip:text;
  color:transparent;
}
.header .tag {
  font-size:11px; padding:3px 10px; border-radius:12px;
  background:linear-gradient(135deg, var(--accent-strong), var(--accent2));
  color:#fff; font-weight:600;
  border:1px solid rgba(255,255,255,0.12);
  box-shadow:0 6px 16px rgba(111, 91, 255, 0.35);
}
.header .tag--status {
  background:rgba(233, 230, 247, 0.07);
  color:var(--text);
  border:1px solid rgba(150, 140, 210, 0.25);
  box-shadow:none;
}
.header .tag--status[data-mode="demo"] {
  background:linear-gradient(135deg, rgba(243, 184, 122, 0.95), rgba(240, 128, 128, 0.85));
  color:#1a1224;
  border-color:rgba(255,255,255,0.15);
}
.header .tag--status[data-mode="live"] {
  background:linear-gradient(135deg, rgba(61, 214, 179, 0.9), rgba(139, 122, 255, 0.82));
  color:#041014;
  border-color:rgba(255,255,255,0.12);
}
.header .powered {
  margin-left:auto; font-size:12px; color:var(--text2);
  font-family:'Sora','Pretendard',sans-serif;
  letter-spacing:0.15px;
}

.container { display:flex; height:calc(100vh - 65px); position:relative; z-index:1; }

/* Left panel */
.left {
  width:50%;
  border-right:1px solid var(--border);
  display:flex; flex-direction:column;
  background:linear-gradient(180deg, rgba(18, 19, 33, 0.7), rgba(12, 13, 24, 0.9));
}

.upload-zone {
  padding:24px; border-bottom:1px solid var(--border);
  background:linear-gradient(180deg, rgba(23, 24, 42, 0.9), rgba(15, 16, 30, 0.9));
}
.drop-area {
  border:1.5px dashed rgba(169, 156, 255, 0.35); border-radius:12px;
  padding:40px 20px; text-align:center; cursor:pointer;
  transition:all 0.2s;
  background:linear-gradient(135deg, rgba(139, 122, 255, 0.08), rgba(17, 18, 33, 0.45));
  box-shadow:inset 0 0 0 1px rgba(139, 122, 255, 0.08);
}
.drop-area:hover {
  border-color:var(--accent);
  background:linear-gradient(135deg, rgba(139, 122, 255, 0.16), rgba(17, 18, 33, 0.55));
  box-shadow:0 0 0 3px rgba(139, 122, 255, 0.12);
  transform:translateY(-1px);
}
.drop-area.dragover {
  border-color:var(--accent);
  background:linear-gradient(135deg, rgba(139, 122, 255, 0.22), rgba(17, 18, 33, 0.6));
  box-shadow:0 0 0 4px rgba(139, 122, 255, 0.2);
}
.drop-area .icon { font-size:36px; margin-bottom:8px; }
.drop-area p { color:var(--text2); font-size:14px; }
.drop-area .formats { font-size:11px; color:var(--text2); margin-top:6px; opacity:0.7; }

.file-input { display:none; }
.sample-row {
  margin-top:12px;
  display:flex;
  gap:10px;
  flex-wrap:wrap;
}
.ghost-btn {
  padding:8px 10px;
  border-radius:10px;
  border:1px solid var(--border);
  background:rgba(18, 19, 33, 0.6);
  color:var(--text);
  font-size:12px;
  cursor:pointer;
  transition:all 0.2s;
}
.ghost-btn:hover {
  border-color:var(--accent2);
  box-shadow:0 0 0 3px rgba(139, 122, 255, 0.12);
  transform:translateY(-1px);
}

.edu-controls {
  margin-top:14px; display:flex; gap:12px; flex-wrap:wrap;
}
.control {
  display:flex; flex-direction:column; gap:6px;
  font-size:12px; color:var(--text2); min-width:160px;
}
.control select {
  padding:10px 12px; border-radius:10px;
  border:1px solid var(--border); background:var(--surface);
  color:var(--text); font-size:13px; outline:none;
}
.control select:focus { border-color:var(--accent); box-shadow:0 0 0 3px var(--glow); }
.control input {
  padding:10px 12px; border-radius:10px;
  border:1px solid var(--border); background:var(--surface);
  color:var(--text); font-size:13px; outline:none;
}
.control input:focus { border-color:var(--accent); box-shadow:0 0 0 3px var(--glow); }
.tag-suggestions {
  margin-top:6px; display:flex; gap:6px; flex-wrap:wrap; align-items:center;
}
.tag-label { font-size:11px; color:var(--text2); }
.tag-suggestions #tagSuggestions {
  display:flex; gap:6px; flex-wrap:wrap;
}
.tag-chip {
  border:1px solid var(--border);
  background:var(--surface2);
  color:var(--text);
  padding:4px 8px;
  border-radius:999px;
  font-size:11px;
  cursor:pointer;
  transition:all 0.2s;
}
.tag-chip:hover { border-color:var(--accent2); transform:translateY(-1px); }
.tag-chip.active {
  background:linear-gradient(135deg, var(--accent-strong), var(--accent2));
  color:#fff;
  border-color:transparent;
}
.runtime-panel {
  margin-top:14px;
  border:1px solid rgba(139, 122, 255, 0.22);
  border-radius:10px;
  padding:12px;
  background:rgba(18, 19, 33, 0.65);
}
.runtime-title {
  font-size:12px;
  color:var(--accent2);
  font-weight:600;
  margin-bottom:8px;
}
.runtime-row {
  display:flex;
  gap:8px;
  flex-wrap:wrap;
}
.runtime-row input {
  flex:1;
  min-width:220px;
  padding:10px 12px;
  border-radius:8px;
  border:1px solid var(--border);
  background:var(--surface2);
  color:var(--text);
  font-size:12px;
  outline:none;
}
.runtime-row input:focus {
  border-color:var(--accent);
  box-shadow:0 0 0 3px var(--glow);
}
.runtime-status {
  margin-top:8px;
  font-size:11px;
  color:var(--text2);
}
.runtime-status.error { color:var(--red); }
.runtime-hint {
  margin-top:6px;
  font-size:11px;
  color:var(--text2);
}
.session-docs {
  margin-top:12px;
  border:1px solid rgba(115, 196, 255, 0.22);
  border-radius:10px;
  padding:10px;
  background:rgba(17, 22, 34, 0.62);
}
.session-docs-head {
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:8px;
  margin-bottom:6px;
}
.session-docs-title {
  font-size:12px;
  color:#9dd8ff;
  font-weight:600;
}
.session-docs-actions {
  display:flex;
  gap:6px;
  flex-wrap:wrap;
}
.session-docs-status {
  font-size:11px;
  color:var(--text2);
  margin-bottom:8px;
}
.session-docs-list {
  display:grid;
  gap:6px;
}
.session-doc-row {
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:8px;
  border:1px solid rgba(115, 196, 255, 0.14);
  border-radius:8px;
  background:rgba(14, 18, 30, 0.8);
  padding:8px;
}
.session-doc-meta {
  min-width:0;
  display:flex;
  flex-direction:column;
  gap:2px;
}
.session-doc-name {
  font-size:12px;
  color:var(--text);
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
  max-width:260px;
}
.session-doc-sub {
  font-size:11px;
  color:var(--text2);
}
.session-doc-buttons {
  display:flex;
  gap:6px;
  flex-wrap:wrap;
}
.session-doc-buttons .ghost-btn {
  padding:6px 8px;
  font-size:11px;
}
.session-doc-row.active {
  border-color:rgba(139, 122, 255, 0.5);
  box-shadow:0 0 0 2px rgba(139, 122, 255, 0.14);
}

.results { flex:1; overflow-y:auto; padding:20px 24px; }

.result-card {
  background:linear-gradient(160deg, rgba(26, 27, 47, 0.9), rgba(18, 19, 33, 0.95));
  border:1px solid var(--border);
  border-radius:10px; padding:16px; margin-bottom:14px;
  box-shadow:var(--shadow);
  animation:rise 0.4s ease both;
  backdrop-filter:blur(6px);
}
.result-card .card-title {
  font-size:12px; font-weight:600; color:var(--accent2);
  text-transform:uppercase; letter-spacing:1px; margin-bottom:10px;
  display:flex; align-items:center; gap:8px;
}
.result-card .card-title .step {
  background:var(--accent-strong); color:#fff; font-size:10px;
  padding:2px 7px; border-radius:8px; font-weight:700;
  box-shadow:0 4px 10px rgba(111, 91, 255, 0.35);
}

.parsed-content {
  font-size:13px; line-height:1.7; color:var(--text);
  white-space:pre-wrap; max-height:250px; overflow-y:auto;
  background:var(--surface2); padding:12px; border-radius:8px;
  font-family:'JetBrains Mono',monospace;
  border:1px solid rgba(139, 122, 255, 0.12);
}

.extracted-grid {
  display:grid; gap:8px;
}
.extracted-item {
  display:flex; gap:8px; font-size:13px;
  padding:8px 12px; background:var(--surface2); border-radius:8px;
  border:1px solid rgba(139, 122, 255, 0.1);
}
.extracted-item .key {
  color:var(--accent2); font-weight:600; min-width:120px; flex-shrink:0;
}
.extracted-item .val { color:var(--text); }

.summary-text {
  font-size:14px; line-height:1.8; color:var(--text);
  padding:12px; background:var(--surface2); border-radius:8px;
  border:1px solid rgba(139, 122, 255, 0.12);
}

.edu-pack { display:grid; gap:12px; }
.edu-section {
  padding:12px; border-radius:8px;
  background:var(--surface2);
  border:1px solid rgba(139, 122, 255, 0.12);
}
.edu-label {
  font-size:12px; font-weight:600; color:var(--accent2);
  letter-spacing:0.3px; margin-bottom:8px;
}
.edu-list {
  margin:0; padding-left:18px;
  font-size:13px; line-height:1.7; color:var(--text);
}
.edu-text { font-size:13px; line-height:1.7; color:var(--text); white-space:pre-wrap; }
.edu-qa { display:flex; flex-direction:column; gap:8px; font-size:13px; }
.edu-qa .qa-item {
  background:var(--surface3); border:1px solid rgba(139, 122, 255, 0.12);
  border-radius:8px; padding:8px 10px;
}
.edu-qa .qa-q { color:var(--accent2); font-weight:600; margin-bottom:4px; }
.edu-qa .qa-a { color:var(--text); }

.export-actions {
  display:flex; gap:10px; flex-wrap:wrap;
}
.export-btn {
  padding:10px 14px; border-radius:10px; border:1px solid var(--border);
  background:var(--surface2); color:var(--text);
  font-size:13px; font-weight:600; cursor:pointer;
  transition:all 0.2s;
}
.export-btn:hover { transform:translateY(-1px); border-color:var(--accent2); }
.export-btn:disabled { opacity:0.45; cursor:not-allowed; transform:none; }
.export-hint { margin-top:8px; font-size:12px; color:var(--text2); }

/* Right panel - Chat */
.right {
  width:50%;
  display:flex; flex-direction:column;
  background:linear-gradient(180deg, rgba(16, 17, 30, 0.6), rgba(12, 12, 24, 0.9));
}

.chat-header {
  padding:16px 24px; border-bottom:1px solid var(--border);
  font-size:14px; font-weight:600; color:var(--text2);
  background:rgba(16, 17, 30, 0.7);
  letter-spacing:0.2px;
  font-family:'Sora','Pretendard',sans-serif;
}

.chat-messages {
  flex:1; overflow-y:auto; padding:20px 24px;
  display:flex; flex-direction:column; gap:12px;
}

.msg {
  max-width:85%; padding:12px 16px; border-radius:14px;
  font-size:14px; line-height:1.7;
  animation:rise 0.35s ease both;
}
.msg.agent {
  align-self:flex-start; background:var(--surface);
  border:1px solid var(--border); border-bottom-left-radius:4px;
  box-shadow:0 8px 18px rgba(10, 11, 22, 0.45);
}
.msg.user {
  align-self:flex-end;
  background:linear-gradient(135deg, var(--accent-strong), #9a8bff);
  color:#fff; border-bottom-right-radius:4px;
  box-shadow:0 10px 20px rgba(111, 91, 255, 0.35);
}
.msg .sender {
  font-size:11px; font-weight:600; margin-bottom:4px; opacity:0.7;
}

.chat-input-area {
  padding:16px 24px; border-top:1px solid var(--border);
  display:flex; gap:10px;
  background:rgba(14, 15, 28, 0.75);
  backdrop-filter:blur(8px);
}
.chat-input-area input {
  flex:1; padding:12px 16px; border-radius:10px;
  border:1px solid var(--border); background:var(--surface);
  color:var(--text); font-size:14px; outline:none;
}
.chat-input-area input:focus { border-color:var(--accent); box-shadow:0 0 0 3px var(--glow); }
.chat-input-area input::placeholder { color:var(--text2); }
.chat-input-area button {
  padding:12px 20px; border-radius:10px; border:none;
  background:linear-gradient(135deg, var(--accent-strong), var(--accent2));
  color:#fff; font-size:14px;
  font-weight:600; cursor:pointer; transition:all 0.2s;
  box-shadow:0 10px 20px rgba(111, 91, 255, 0.35);
}
.chat-input-area button:hover { transform:translateY(-1px); filter:brightness(1.05); }
.chat-input-area button:disabled { opacity:0.4; cursor:not-allowed; }

.community-panel {
  border-top:1px solid var(--border);
  padding:14px 24px;
  display:flex;
  flex-direction:column;
  gap:8px;
  background:rgba(14, 15, 28, 0.82);
}
.community-title {
  font-size:12px;
  font-weight:600;
  color:var(--accent2);
  letter-spacing:0.3px;
}
.community-grid {
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:8px;
}
.community-grid input,
.community-panel textarea {
  width:100%;
  border:1px solid var(--border);
  border-radius:8px;
  background:var(--surface2);
  color:var(--text);
  padding:8px 10px;
  font-size:12px;
}
.community-panel textarea {
  min-height:68px;
  resize:vertical;
}
.community-actions {
  display:flex;
  gap:8px;
  align-items:center;
}
.community-actions button {
  padding:9px 12px;
  border-radius:8px;
  border:none;
  background:linear-gradient(135deg, var(--accent-strong), var(--accent2));
  color:#fff;
  font-size:12px;
  font-weight:600;
  cursor:pointer;
}
.community-actions button:disabled {
  opacity:0.55;
  cursor:not-allowed;
}
.community-status {
  font-size:11px;
  color:var(--text2);
}
.community-status.error { color:var(--red); }
.community-hint {
  font-size:11px;
  color:var(--text2);
}

.trust-panel {
  border-top:1px solid var(--border);
  padding:14px 24px 18px;
  display:grid;
  gap:8px;
  background:rgba(14, 15, 28, 0.86);
}
.trust-title {
  font-size:12px;
  color:var(--accent2);
  font-weight:600;
}
.trust-list {
  font-size:11px;
  color:var(--text2);
  line-height:1.5;
  display:grid;
  gap:4px;
}
.sponsored-slot {
  border:1px dashed var(--border);
  border-radius:10px;
  overflow:hidden;
  min-height:96px;
  background:rgba(18, 19, 33, 0.65);
  padding:6px;
}
.ad-slot-row {
  display:flex;
  gap:8px;
  align-items:center;
  margin-bottom:8px;
}
.ad-slot-row input {
  flex:1;
  padding:8px 10px;
  border:1px solid var(--border);
  border-radius:8px;
  background:var(--surface2);
  color:var(--text);
  font-size:12px;
}
.ad-slot-row button {
  padding:8px 10px;
  border-radius:8px;
  border:1px solid var(--border);
  background:var(--surface2);
  color:var(--text);
  font-size:12px;
  cursor:pointer;
}
.ad-slot-help {
  font-size:11px;
  color:var(--text2);
  margin-bottom:8px;
}
.ad-placeholder {
  font-size:11px;
  color:var(--text2);
  text-align:center;
  padding:20px 12px;
}

/* Loading */
.loader {
  display:none; padding:24px; text-align:center;
}
.loader.active { display:block; }
.loader .spinner {
  width:36px; height:36px; border:3px solid var(--border);
  border-top-color:var(--accent); border-radius:50%;
  animation:spin 0.8s linear infinite; margin:0 auto 12px;
}
@keyframes spin { to { transform:rotate(360deg); } }
.loader .steps {
  font-size:13px; color:var(--text2); line-height:2;
}
.loader .steps .done { color:var(--green); }
.loader .steps .active-step { color:var(--accent2); font-weight:600; }
.loader-actions {
  margin-top:10px;
  display:flex;
  align-items:center;
  justify-content:center;
  gap:8px;
  flex-wrap:wrap;
}
.loader-status {
  font-size:12px;
  color:var(--text2);
}
.loader-status.error { color:var(--red); }

.empty-state {
  flex:1; display:flex; align-items:center; justify-content:center;
  color:var(--text2); font-size:14px; text-align:center; padding:40px;
  line-height:1.8;
  margin:16px;
  border-radius:16px;
  border:1px dashed rgba(193, 181, 255, 0.2);
  background:linear-gradient(160deg, rgba(26, 27, 47, 0.5), rgba(16, 17, 30, 0.4));
}

/* Pipeline badge */
.pipeline {
  display:flex; gap:4px; align-items:center; padding:12px 24px;
  border-bottom:1px solid var(--border); font-size:11px;
  background:rgba(14, 15, 28, 0.7);
}
.pipeline .pipe-step {
  padding:4px 10px; border-radius:6px; background:var(--surface2);
  color:var(--text2); font-weight:500;
}
.pipeline .pipe-step.active {
  background:linear-gradient(135deg, var(--accent-strong), var(--accent2));
  color:#fff;
  box-shadow:0 6px 14px rgba(111, 91, 255, 0.35);
}
.pipeline .arrow { color:var(--text2); }
@keyframes rise {
  from { opacity:0; transform:translateY(6px); }
  to { opacity:1; transform:translateY(0); }
}

@media (max-width: 980px) {
  .header { flex-wrap:wrap; }
  .header .powered { margin-left:0; width:100%; }
  .pipeline { flex-wrap:wrap; row-gap:6px; }
  .container { flex-direction:column; height:auto; min-height:calc(100vh - 65px); }
  .left, .right { width:100%; }
  .left { border-right:none; border-bottom:1px solid var(--border); }
  .upload-zone { padding:20px; }
  .drop-area { padding:28px 16px; }
  .chat-messages { max-height:60vh; }
  .session-doc-name { max-width:160px; }
}
</style>

<meta name="ga-measurement-id" content="G-XXXXXXXXXX" />
<meta name="clarity-project-id" content="CLARITY_PROJECT_ID" />
<meta name="gtm-container-id" content="GTM-MHK4C4D7" />
<meta name="analytics-require-consent" content="false" />
</head>
<body>

<div class="header">
  <div class="brand">
    <img class="brand-logo" src="assets/docuagent-logo.svg" alt="DocuAgent logo">
    <div class="brand-text">
      <div class="brand-sub">업스테이지 엠버서더 · 도큐 에이전트</div>
    </div>
  </div>
  <h1>Docu<span>Agent</span></h1>
  <div class="tag">문서 분석</div>
  <div class="tag tag--status" id="modeTag" title="Runtime mode">...</div>
  <div class="powered" id="poweredLine">Upstage Solar · Document Parse · Information Extract</div>
</div>

<div class="pipeline">
  <div class="pipe-step" id="ps1">Document Parse</div>
  <div class="arrow">→</div>
  <div class="pipe-step" id="ps2">Information Extract</div>
  <div class="arrow">→</div>
  <div class="pipe-step" id="ps3">Solar 처리</div>
  <div class="arrow">→</div>
  <div class="pipe-step" id="ps4">교육 콘텐츠</div>
</div>

<div class="container">
  <!-- Left: Upload & Results -->
  <div class="left">
    <div class="upload-zone">
      <div class="drop-area" id="dropArea">
        <p>문서를 드래그하거나 클릭하여 업로드</p>
        <div class="formats">PDF, PNG, JPG, TIFF 지원</div>
      </div>
      <input type="file" class="file-input" id="fileInput" accept=".pdf,.png,.jpg,.jpeg,.tiff">
      <div class="sample-row">
        <button type="button" class="ghost-btn" id="sampleKo">샘플 불러오기 (KO)</button>
        <button type="button" class="ghost-btn" id="sampleEn">Sample (EN)</button>
      </div>
      <div class="edu-controls">
        <div class="control">
          <label for="audienceSelect">학습자 수준</label>
          <select id="audienceSelect">
            <option value="중/고등학생">중/고등학생</option>
            <option value="대학생" selected>대학생</option>
            <option value="직무/실무">직무/실무</option>
            <option value="일반">일반</option>
          </select>
        </div>
        <div class="control">
          <label for="goalSelect">학습 목표</label>
          <select id="goalSelect">
            <option value="핵심 이해" selected>핵심 이해</option>
            <option value="시험 대비">시험 대비</option>
            <option value="강의/발표">강의/발표</option>
            <option value="프로젝트/업무 적용">프로젝트/업무 적용</option>
          </select>
        </div>
        <div class="control" style="min-width:220px;">
          <label for="tagInput">LOM 태그 (쉼표 구분)</label>
          <input type="text" id="tagInput" placeholder="예: 계약서, 개인정보, 리스크">
          <div class="tag-suggestions">
            <span class="tag-label">추천:</span>
            <div id="tagSuggestions"></div>
          </div>
        </div>
      </div>
      <div class="runtime-panel">
        <div class="runtime-title">Runtime API Key</div>
        <div class="runtime-row">
          <input type="password" id="upstageApiKey" placeholder="Upstage API Key (UPSTAGE_API_KEY 없이 실행 가능)">
          <button type="button" class="ghost-btn" id="saveApiKeyBtn">API 키 적용</button>
          <button type="button" class="ghost-btn" id="clearApiKeyBtn">키 삭제</button>
        </div>
        <div class="runtime-status" id="apiKeyStatus"></div>
        <div class="runtime-hint">입력한 키는 현재 서버 세션에만 저장되며 브라우저 저장소(localStorage)에 남기지 않습니다.</div>
      </div>
      <div class="session-docs">
        <div class="session-docs-head">
          <div class="session-docs-title">세션 문서</div>
          <div class="session-docs-actions">
            <button type="button" class="ghost-btn" id="refreshDocsBtn">새로고침</button>
            <button type="button" class="ghost-btn" id="clearDocsBtn">전체 삭제</button>
          </div>
        </div>
        <div class="session-docs-status" id="docsStatus">이 세션에서 분석한 문서가 여기에 표시됩니다.</div>
        <div class="session-docs-list" id="docsList"></div>
      </div>
    </div>

    <div class="loader" id="loader">
      <div class="spinner"></div>
    <div class="steps">
      <div id="step1">Document Parse — 문서 구조 분석 중...</div>
      <div id="step2">Information Extract — 핵심 정보 추출 중...</div>
      <div id="step3">Solar 처리 — 분석 요약 생성 중...</div>
      <div id="step4">교육 콘텐츠 — 학습 자료 생성 중...</div>
    </div>
    <div class="loader-actions">
      <button type="button" class="ghost-btn" id="cancelJobBtn" disabled>분석 취소</button>
      <div class="loader-status" id="jobStatus"></div>
    </div>
  </div>

    <div class="results" id="results" style="display:none;">
      <!-- 파싱 결과 -->
      <div class="result-card">
        <div class="card-title"><span class="step">1</span>Document Parse 결과</div>
        <div class="parsed-content" id="parsedContent"></div>
      </div>

      <!-- 추출 결과 -->
      <div class="result-card">
        <div class="card-title"><span class="step">2</span>Information Extract 결과</div>
        <div class="extracted-grid" id="extractedGrid"></div>
      </div>

      <!-- 요약 -->
      <div class="result-card">
        <div class="card-title"><span class="step">3</span>Solar 분석 요약</div>
        <div class="summary-text" id="summaryText"></div>
      </div>

      <!-- 교육 콘텐츠 -->
      <div class="result-card">
        <div class="card-title"><span class="step">4</span>교육 콘텐츠 패키지</div>
        <div class="edu-pack" id="eduPack">
          <div class="edu-section">
            <div class="edu-label">학습 목표</div>
            <ul class="edu-list" id="eduObjectives"></ul>
          </div>
          <div class="edu-section">
            <div class="edu-label">핵심 개념</div>
            <ul class="edu-list" id="eduConcepts"></ul>
          </div>
          <div class="edu-section">
            <div class="edu-label">교육용 요약</div>
            <div class="edu-text" id="eduSummary"></div>
          </div>
          <div class="edu-section">
            <div class="edu-label">퀴즈</div>
            <div class="edu-qa" id="eduQuiz"></div>
          </div>
          <div class="edu-section">
            <div class="edu-label">플래시카드</div>
            <div class="edu-qa" id="eduCards"></div>
          </div>
          <div class="edu-section">
            <div class="edu-label">활동/과제</div>
            <ul class="edu-list" id="eduActivities"></ul>
          </div>
        </div>
      </div>

      <!-- Export -->
      <div class="result-card">
        <div class="card-title"><span class="step">5</span>결과 내보내기</div>
        <div class="export-actions">
          <button class="export-btn" id="exportMarkdown" disabled>Notion용 Markdown</button>
          <button class="export-btn" id="exportHtml" disabled>LMS용 HTML</button>
          <button class="export-btn" id="exportPdf" disabled>PDF 저장</button>
          <button class="export-btn" id="exportScorm" disabled>SCORM 1.2</button>
          <button class="export-btn" id="exportIms" disabled>IMS CC 1.1</button>
          <button class="export-btn" id="exportScorm2004" disabled>SCORM 2004</button>
          <button class="export-btn" id="exportIms13" disabled>IMS CC 1.3</button>
        </div>
        <div class="export-hint">PDF는 새 창에서 인쇄 기능으로 저장됩니다. SCORM 1.2/2004, IMS CC 1.1/1.3은 ZIP으로 다운로드됩니다.</div>
      </div>
    </div>
  </div>

  <!-- Right: Chat -->
  <div class="right">
    <div class="chat-header">문서 질의응답</div>

    <div class="chat-messages" id="chatMessages">
      <div class="empty-state" id="emptyChat">
        문서를 업로드하면<br>질문을 보낼 수 있습니다
      </div>
    </div>

    <div class="chat-input-area">
      <input type="text" id="chatInput" placeholder="문서에 대해 질문하세요..." disabled>
      <button id="sendBtn" disabled>전송</button>
    </div>

    <div class="community-panel">
      <div class="community-title">Community Feedback (Formspree)</div>
      <div class="community-grid">
        <input id="communityName" placeholder="이름">
        <input id="communityEmail" type="email" placeholder="이메일">
      </div>
      <textarea id="communityMessage" placeholder="DocuAgent에서 개선할 점을 알려주세요."></textarea>
      <input id="communityEndpoint" placeholder="Formspree endpoint (https://formspree.io/f/...)">
      <div class="community-actions">
        <button id="communitySubmit">피드백 전송</button>
        <div id="communityStatus" class="community-status"></div>
      </div>
      <div class="community-hint">엔드포인트는 브라우저 localStorage에 저장됩니다.</div>
    </div>

    <div class="trust-panel">
      <div class="trust-title">Trust & Policy</div>
      <div class="trust-list">
        <div>Contact: <a href="https://github.com/KIM3310/Upstage-DocuAgent/issues">GitHub Issues</a></div>
        <div>Privacy: 문서 분석 결과 저장은 사용자가 실행한 세션 범위에서만 수행됩니다.</div>
        <div>Terms: AI 생성 결과는 검토 후 사용해야 하며, 최종 책임은 사용자에게 있습니다.</div>
        <div>Links: <a href="./about.html">About</a> · <a href="./privacy.html">Privacy</a> · <a href="./terms.html">Terms</a> · <a href="./contact.html">Contact</a> · <a href="./compliance.html">Compliance</a></div>
      </div>
      <div class="ad-slot-row">
        <input id="adsSlotInput" placeholder="AdSense 슬롯 ID (숫자)">
        <button type="button" id="adsSlotApply">슬롯 적용</button>
      </div>
      <div class="ad-slot-help">광고 단위에서 발급된 슬롯 ID를 입력하면 아래 광고 영역에 노출됩니다.</div>
      <div class="sponsored-slot">
        <div class="ad-placeholder" id="adPlaceholder">광고 영역 준비됨: AdSense 슬롯 ID를 입력하세요.</div>
        <ins
          class="adsbygoogle"
          style="display:none"
          data-ad-client="ca-pub-4973160293737562"
          data-ad-slot=""
          data-ad-format="auto"
          data-full-width-responsive="true"></ins>
      </div>
    </div>
  </div>
</div>

<script>
const dropArea = document.getElementById('dropArea');
const fileInput = document.getElementById('fileInput');
const loader = document.getElementById('loader');
const results = document.getElementById('results');
const chatMessages = document.getElementById('chatMessages');
const chatInput = document.getElementById('chatInput');
const sendBtn = document.getElementById('sendBtn');
const emptyChat = document.getElementById('emptyChat');
const audienceSelect = document.getElementById('audienceSelect');
const goalSelect = document.getElementById('goalSelect');
const tagInput = document.getElementById('tagInput');
const tagSuggestions = document.getElementById('tagSuggestions');
const exportMarkdown = document.getElementById('exportMarkdown');
const exportHtml = document.getElementById('exportHtml');
const exportPdf = document.getElementById('exportPdf');
const exportScorm = document.getElementById('exportScorm');
const exportIms = document.getElementById('exportIms');
const exportScorm2004 = document.getElementById('exportScorm2004');
const exportIms13 = document.getElementById('exportIms13');
const modeTag = document.getElementById('modeTag');
const poweredLine = document.getElementById('poweredLine');
const docsList = document.getElementById('docsList');
const docsStatus = document.getElementById('docsStatus');
const refreshDocsBtn = document.getElementById('refreshDocsBtn');
const clearDocsBtn = document.getElementById('clearDocsBtn');
const sampleKo = document.getElementById('sampleKo');
const sampleEn = document.getElementById('sampleEn');
const communityName = document.getElementById('communityName');
const communityEmail = document.getElementById('communityEmail');
const communityMessage = document.getElementById('communityMessage');
const communityEndpoint = document.getElementById('communityEndpoint');
const communitySubmit = document.getElementById('communitySubmit');
const communityStatus = document.getElementById('communityStatus');
const upstageApiKeyInput = document.getElementById('upstageApiKey');
const saveApiKeyBtn = document.getElementById('saveApiKeyBtn');
const clearApiKeyBtn = document.getElementById('clearApiKeyBtn');
const apiKeyStatus = document.getElementById('apiKeyStatus');
const adsSlotInput = document.getElementById('adsSlotInput');
const adsSlotApply = document.getElementById('adsSlotApply');
const adPlaceholder = document.getElementById('adPlaceholder');
const cancelJobBtn = document.getElementById('cancelJobBtn');
const jobStatus = document.getElementById('jobStatus');

let progressTimers = [];
let lastAnalysis = null;
let currentDocId = null;
let tagSyncTimer = null;
let currentRecommendations = [];
let activeAnalysisJobId = null;

const COMMUNITY_ENDPOINT_KEY = 'docuagent_formspree_endpoint';
const ADSENSE_SLOT_STORAGE_KEY = 'docuagent_adsense_slot';
const ADSENSE_CLIENT = 'ca-pub-4973160293737562';
if (communityEndpoint) {
  const saved = localStorage.getItem(COMMUNITY_ENDPOINT_KEY) || '';
  communityEndpoint.value = saved;
  communityEndpoint.addEventListener('change', () => {
    localStorage.setItem(COMMUNITY_ENDPOINT_KEY, communityEndpoint.value.trim());
  });
}

function setCommunityStatus(message, isError = false) {
  if (!communityStatus) return;
  communityStatus.textContent = message || '';
  communityStatus.className = isError ? 'community-status error' : 'community-status';
}

async function submitCommunityFeedback() {
  if (!communityEndpoint || !communitySubmit) return;
  const endpoint = String(communityEndpoint.value || '').trim();
  if (!endpoint) {
    setCommunityStatus('Formspree endpoint를 입력하세요.', true);
    return;
  }
  const payload = {
    name: communityName ? String(communityName.value || '').trim() : '',
    email: communityEmail ? String(communityEmail.value || '').trim() : '',
    message: communityMessage ? String(communityMessage.value || '').trim() : '',
    source: 'upstage-docuagent',
    page_url: window.location.href,
  };
  if (!payload.message) {
    setCommunityStatus('메시지를 입력하세요.', true);
    return;
  }

  communitySubmit.disabled = true;
  setCommunityStatus('전송 중...');
  try {
    const resp = await fetch(endpoint, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Accept': 'application/json',
      },
      body: JSON.stringify(payload),
    });
    const data = await resp.json().catch(() => ({}));
    if (!resp.ok) {
      const msg = (data && data.errors && data.errors[0] && data.errors[0].message) || data.error || '요청 실패';
      throw new Error(String(msg));
    }
    if (communityMessage) {
      communityMessage.value = '';
    }
    setCommunityStatus('피드백 전송 완료');
  } catch (err) {
    setCommunityStatus(`전송 실패: ${err?.message || String(err)}`, true);
  } finally {
    communitySubmit.disabled = false;
  }
}

if (communitySubmit) {
  communitySubmit.addEventListener('click', submitCommunityFeedback);
}

function validAdSenseClient(value) {
  return /^ca-pub-\d{16}$/.test(value || '');
}

function validAdSenseSlot(value) {
  return /^\d{8,20}$/.test(value || '');
}

function setApiKeyStatus(message, isError = false) {
  if (!apiKeyStatus) return;
  apiKeyStatus.textContent = message || '';
  apiKeyStatus.className = isError ? 'runtime-status error' : 'runtime-status';
}

function setJobStatus(message, isError = false) {
  if (!jobStatus) return;
  jobStatus.textContent = message || '';
  jobStatus.className = isError ? 'loader-status error' : 'loader-status';
}

function maskKey(value) {
  const text = String(value || '').trim();
  if (!text) return '';
  if (text.length <= 8) return '*'.repeat(text.length);
  return `${text.slice(0, 4)}${'*'.repeat(text.length - 8)}${text.slice(-4)}`;
}

function formatUtc(value) {
  if (!value) return '-';
  const dt = new Date(value);
  if (Number.isNaN(dt.getTime())) return value;
  return dt.toLocaleString();
}

function apiErrorMessage(data, fallback = '요청 실패') {
  if (!data || typeof data !== 'object') return fallback;
  const detail = data.detail || fallback;
  const requestId = data.request_id ? ` [request_id=${data.request_id}]` : '';
  return `${detail}${requestId}`;
}

async function apiFetch(url, options = {}) {
  const resp = await fetch(url, options);
  const data = await resp.json().catch(() => ({}));
  if (!resp.ok) {
    throw new Error(apiErrorMessage(data, '요청 실패'));
  }
  return data;
}

async function fetchRuntimeConfig() {
  return apiFetch('/api/runtime/config');
}

async function applyRuntimeApiKey(rawKey, { silent = false, refreshHealth = true } = {}) {
  const key = String(rawKey || '').trim();
  if (key && key.length < 12) {
    if (!silent) setApiKeyStatus('API 키 형식이 너무 짧습니다. (최소 12자)', true);
    return null;
  }

  if (saveApiKeyBtn) saveApiKeyBtn.disabled = true;
  if (clearApiKeyBtn) clearApiKeyBtn.disabled = true;
  const formData = new FormData();
  formData.append('upstage_api_key', key);

  try {
    const data = await apiFetch('/api/runtime/config', { method: 'POST', body: formData });
    if (!silent) {
      if (data.runtime_key_configured) {
        setApiKeyStatus(`API 키 적용 완료 (${data.masked_runtime_key || maskKey(key)}) · 현재 세션에만 저장됩니다.`);
      } else if (data.effective_key_configured) {
        setApiKeyStatus('런타임 키는 제거되었고 서버 환경 키가 사용 중입니다.');
      } else {
        setApiKeyStatus('API 키 미설정: DEMO 모드');
      }
    }
    if (refreshHealth) await initHealth();
    return data;
  } catch (err) {
    if (!silent) {
      setApiKeyStatus(`API 키 설정 실패: ${err?.message || String(err)}`, true);
    }
    return null;
  } finally {
    if (saveApiKeyBtn) saveApiKeyBtn.disabled = false;
    if (clearApiKeyBtn) clearApiKeyBtn.disabled = false;
  }
}

async function initializeRuntimeKey() {
  if (!upstageApiKeyInput) return;
  upstageApiKeyInput.value = '';
  try {
    const state = await fetchRuntimeConfig();
    if (state.runtime_key_configured) {
      setApiKeyStatus(`현재 세션 API 키 적용됨 (${state.masked_runtime_key || ''})`);
    } else if (state.effective_key_configured) {
      setApiKeyStatus('서버 환경 키로 LIVE 모드 동작 중');
    } else {
      setApiKeyStatus('API 키를 입력하면 LIVE 모드로 전환됩니다. 키는 브라우저에 저장되지 않습니다.');
    }
  } catch (err) {
    setApiKeyStatus(`런타임 설정 조회 실패: ${err?.message || String(err)}`, true);
  }
}

function setDocsStatus(message, isError = false) {
  if (!docsStatus) return;
  docsStatus.textContent = message || '';
  docsStatus.style.color = isError ? 'var(--red)' : '';
}

function renderDocList(items = []) {
  if (!docsList) return;
  docsList.innerHTML = '';
  if (!Array.isArray(items) || items.length === 0) {
    setDocsStatus('이 세션에서 분석한 문서가 없습니다.');
    return;
  }
  setDocsStatus(`최근 문서 ${items.length}개`);
  items.forEach(item => {
    const row = document.createElement('div');
    row.className = 'session-doc-row';
    if ((item.doc_id || '') === (currentDocId || '')) {
      row.classList.add('active');
    }

    const meta = document.createElement('div');
    meta.className = 'session-doc-meta';
    const name = document.createElement('div');
    name.className = 'session-doc-name';
    name.textContent = item.filename || '(untitled)';
    const sub = document.createElement('div');
    sub.className = 'session-doc-sub';
    const mode = (item.mode || 'demo').toUpperCase();
    sub.textContent = `${mode} · ${formatUtc(item.created_at_utc || '')}`;
    meta.appendChild(name);
    meta.appendChild(sub);

    const buttons = document.createElement('div');
    buttons.className = 'session-doc-buttons';
    const loadBtn = document.createElement('button');
    loadBtn.type = 'button';
    loadBtn.className = 'ghost-btn';
    loadBtn.textContent = '불러오기';
    loadBtn.addEventListener('click', () => loadDocFromSession(item.doc_id));
    const delBtn = document.createElement('button');
    delBtn.type = 'button';
    delBtn.className = 'ghost-btn';
    delBtn.textContent = '삭제';
    delBtn.addEventListener('click', () => deleteDocFromSession(item.doc_id));
    buttons.appendChild(loadBtn);
    buttons.appendChild(delBtn);

    row.appendChild(meta);
    row.appendChild(buttons);
    docsList.appendChild(row);
  });
}

async function refreshDocList({ silent = false } = {}) {
  try {
    const payload = await apiFetch('/api/docs?limit=30&offset=0');
    renderDocList(payload.items || []);
  } catch (err) {
    if (!silent) setDocsStatus(`문서 목록 조회 실패: ${err?.message || String(err)}`, true);
  }
}

async function loadDocFromSession(docId) {
  if (!docId) return;
  try {
    setDocsStatus('문서 불러오는 중...');
    const data = await apiFetch(`/api/docs/${encodeURIComponent(docId)}`);
    applyAnalysisResult(data, { announce: false });
    addMsg('agent', `"${data.filename}" 문서를 세션 기록에서 불러왔습니다.`);
    await refreshDocList({ silent: true });
  } catch (err) {
    setDocsStatus(`문서 불러오기 실패: ${err?.message || String(err)}`, true);
  }
}

async function deleteDocFromSession(docId) {
  if (!docId) return;
  try {
    await apiFetch(`/api/docs/${encodeURIComponent(docId)}`, { method: 'DELETE' });
    if (currentDocId === docId) {
      currentDocId = null;
      lastAnalysis = null;
      docReady = false;
      setExportEnabled(false);
      chatInput.disabled = true;
      sendBtn.disabled = true;
      emptyChat.style.display = 'flex';
      results.style.display = 'none';
    }
    await refreshDocList({ silent: true });
  } catch (err) {
    setDocsStatus(`문서 삭제 실패: ${err?.message || String(err)}`, true);
  }
}

async function clearSessionDocs() {
  try {
    const payload = await apiFetch('/api/docs/clear', { method: 'POST' });
    currentDocId = null;
    lastAnalysis = null;
    docReady = false;
    setExportEnabled(false);
    chatInput.disabled = true;
    sendBtn.disabled = true;
    emptyChat.style.display = 'flex';
    results.style.display = 'none';
    setDocsStatus(`세션 문서 ${payload.deleted || 0}개를 삭제했습니다.`);
    await refreshDocList({ silent: true });
  } catch (err) {
    setDocsStatus(`전체 삭제 실패: ${err?.message || String(err)}`, true);
  }
}

function setAdPlaceholder(message) {
  if (!adPlaceholder) return;
  adPlaceholder.textContent = message || '';
  adPlaceholder.style.display = 'block';
}

function applyAdsenseSlot(rawSlot, { persist = false } = {}) {
  const slot = String(rawSlot || '').trim();
  if (persist) {
    if (slot) {
      localStorage.setItem(ADSENSE_SLOT_STORAGE_KEY, slot);
    } else {
      localStorage.removeItem(ADSENSE_SLOT_STORAGE_KEY);
    }
  }

  const adNode = document.querySelector('.adsbygoogle');
  if (!adNode) return;
  adNode.setAttribute('data-ad-client', ADSENSE_CLIENT);
  if (!validAdSenseClient(ADSENSE_CLIENT) || !validAdSenseSlot(slot)) {
    adNode.style.display = 'none';
    setAdPlaceholder('광고 영역 준비됨: AdSense 슬롯 ID를 입력하세요.');
    return;
  }

  adNode.setAttribute('data-ad-slot', slot);
  adNode.style.display = 'block';
  setAdPlaceholder('광고 로딩 중...');
  try {
    (window.adsbygoogle = window.adsbygoogle || []).push({});
    if (adPlaceholder) adPlaceholder.style.display = 'none';
  } catch (_err) {
    setAdPlaceholder('광고 로딩 대기 중입니다. 새로고침 후 다시 확인하세요.');
  }
}

function initializeAdsenseControls() {
  const saved = localStorage.getItem(ADSENSE_SLOT_STORAGE_KEY) || '';
  if (adsSlotInput) {
    adsSlotInput.value = saved;
  }
  applyAdsenseSlot(saved, { persist: false });
}

if (saveApiKeyBtn) {
  saveApiKeyBtn.addEventListener('click', () => applyRuntimeApiKey(upstageApiKeyInput?.value || ''));
}
if (clearApiKeyBtn) {
  clearApiKeyBtn.addEventListener('click', () => {
    if (upstageApiKeyInput) upstageApiKeyInput.value = '';
    applyRuntimeApiKey('');
  });
}
if (upstageApiKeyInput) {
  upstageApiKeyInput.addEventListener('keydown', e => {
    if (e.key === 'Enter') {
      e.preventDefault();
      applyRuntimeApiKey(upstageApiKeyInput.value || '');
    }
  });
}
if (refreshDocsBtn) {
  refreshDocsBtn.addEventListener('click', () => refreshDocList());
}
if (clearDocsBtn) {
  clearDocsBtn.addEventListener('click', () => clearSessionDocs());
}
if (adsSlotApply) {
  adsSlotApply.addEventListener('click', () => applyAdsenseSlot(adsSlotInput?.value || '', { persist: true }));
}
if (adsSlotInput) {
  adsSlotInput.addEventListener('keydown', e => {
    if (e.key === 'Enter') {
      e.preventDefault();
      applyAdsenseSlot(adsSlotInput.value || '', { persist: true });
    }
  });
}
if (cancelJobBtn) {
  cancelJobBtn.addEventListener('click', () => cancelCurrentJob());
}

function resetProgressTimers() {
  progressTimers.forEach(clearTimeout);
  progressTimers = [];
}

function stepTitle(index) {
  if (index === 1) return 'Document Parse';
  if (index === 2) return 'Information Extract';
  if (index === 3) return 'Solar 처리';
  return '교육 콘텐츠';
}

function setStepVisual(index, state, label = '') {
  const node = document.getElementById(`step${index}`);
  if (!node) return;
  const title = stepTitle(index);
  if (state === 'done') {
    node.className = 'done';
    node.textContent = `${title} — 완료`;
    return;
  }
  if (state === 'active') {
    node.className = 'active-step';
    node.textContent = `${label || title} — 처리 중...`;
    return;
  }
  node.className = '';
  node.textContent = `${title} — 대기 중`;
}

function setPipelineActive(index) {
  for (let i = 1; i <= 4; i++) {
    const node = document.getElementById(`ps${i}`);
    if (!node) continue;
    node.classList.toggle('active', i === index);
  }
}

function updateProgressFromJob(job) {
  const status = String(job?.status || 'queued');
  const rawStep = Number(job?.step || 0);
  const step = Math.max(1, Math.min(4, rawStep || 1));
  const label = String(job?.progress_label || '').trim();

  if (status === 'queued') {
    setStepVisual(1, 'active', '분석 작업');
    setStepVisual(2, 'pending');
    setStepVisual(3, 'pending');
    setStepVisual(4, 'pending');
    setPipelineActive(1);
    setJobStatus('작업 대기 중...');
    return;
  }

  if (status === 'running') {
    for (let i = 1; i <= 4; i++) {
      if (i < step) setStepVisual(i, 'done');
      else if (i === step) setStepVisual(i, 'active', label || stepTitle(i));
      else setStepVisual(i, 'pending');
    }
    setPipelineActive(step);
    setJobStatus(label ? `${label} 진행 중` : '분석 진행 중');
    return;
  }

  if (status === 'canceling') {
    for (let i = 1; i <= 4; i++) {
      if (i < step) setStepVisual(i, 'done');
      else if (i === step) setStepVisual(i, 'active', `${stepTitle(i)} 취소 중`);
      else setStepVisual(i, 'pending');
    }
    setPipelineActive(step);
    setJobStatus('취소 요청됨...');
    return;
  }

  if (status === 'completed') {
    for (let i = 1; i <= 4; i++) setStepVisual(i, 'done');
    setPipelineActive(4);
    setJobStatus('분석 완료');
    return;
  }

  if (status === 'failed') {
    for (let i = 1; i <= 4; i++) {
      if (i < step) setStepVisual(i, 'done');
      else if (i === step) setStepVisual(i, 'active', `${stepTitle(i)} 실패`);
      else setStepVisual(i, 'pending');
    }
    setPipelineActive(step);
    setJobStatus('분석 실패', true);
    return;
  }

  if (status === 'canceled') {
    for (let i = 1; i <= 4; i++) {
      if (i < step) setStepVisual(i, 'done');
      else setStepVisual(i, 'pending');
    }
    setPipelineActive(step);
    setJobStatus('분석 작업이 취소되었습니다.');
  }
}

async function waitForAnalysisJob(jobId, { timeoutMs = 5 * 60 * 1000, pollMs = 900 } = {}) {
  const started = Date.now();
  while (true) {
    const job = await apiFetch(`/api/analyze/jobs/${encodeURIComponent(jobId)}`);
    updateProgressFromJob(job);
    if (job.status === 'completed') {
      if (job.result) return job.result;
      if (job.doc_id) {
        return apiFetch(`/api/docs/${encodeURIComponent(job.doc_id)}`);
      }
      throw new Error('작업은 완료되었지만 결과를 찾을 수 없습니다.');
    }
    if (job.status === 'failed') {
      throw new Error(job.error || '분석 작업이 실패했습니다.');
    }
    if (job.status === 'canceled') {
      throw new Error(job.error || '분석 작업이 취소되었습니다.');
    }
    if (Date.now() - started > timeoutMs) {
      throw new Error('분석 시간이 초과되었습니다. 잠시 후 다시 시도해주세요.');
    }
    await new Promise(resolve => setTimeout(resolve, pollMs));
  }
}

async function cancelCurrentJob() {
  if (!activeAnalysisJobId) return;
  if (cancelJobBtn) cancelJobBtn.disabled = true;
  setJobStatus('취소 요청 중...');
  try {
    const payload = await apiFetch(`/api/analyze/jobs/${encodeURIComponent(activeAnalysisJobId)}/cancel`, {
      method: 'POST',
    });
    updateProgressFromJob(payload);
  } catch (err) {
    setJobStatus(`취소 실패: ${err?.message || String(err)}`, true);
    if (cancelJobBtn) cancelJobBtn.disabled = false;
  }
}

function setExportEnabled(enabled) {
  exportMarkdown.disabled = !enabled;
  exportHtml.disabled = !enabled;
  exportPdf.disabled = !enabled;
  exportScorm.disabled = !enabled;
  exportIms.disabled = !enabled;
  exportScorm2004.disabled = !enabled;
  exportIms13.disabled = !enabled;
}

let docReady = false;

// Drag & drop
dropArea.addEventListener('click', () => fileInput.click());
dropArea.addEventListener('dragover', e => { e.preventDefault(); dropArea.classList.add('dragover'); });
dropArea.addEventListener('dragleave', () => dropArea.classList.remove('dragover'));
dropArea.addEventListener('drop', e => {
  e.preventDefault();
  dropArea.classList.remove('dragover');
  if(e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]);
});
fileInput.addEventListener('change', e => { if(e.target.files.length) handleFile(e.target.files[0]); });

async function initHealth() {
  if(!modeTag) return;
  try {
    const data = await apiFetch('/healthz');
    const demo = !!data.demo_mode;
    modeTag.textContent = demo ? 'DEMO' : 'LIVE';
    modeTag.dataset.mode = demo ? 'demo' : 'live';
    modeTag.title = demo
      ? 'Demo mode: runs end-to-end without paid keys (no external API calls)'
      : 'Live mode: Upstage API key detected (runtime/env)';
    if(poweredLine) {
      poweredLine.textContent = demo
        ? 'Demo mode · Local parse + deterministic outputs (set API key for live)'
        : 'Upstage Solar · Document Parse · Information Extract';
    }
  } catch {
    modeTag.textContent = '...';
  }
}

async function loadSample(url, filename) {
  try {
    const resp = await fetch(url);
    if(!resp.ok) throw new Error('샘플 파일을 찾을 수 없습니다.');
    const blob = await resp.blob();
    const file = new File([blob], filename, { type: blob.type || 'application/pdf' });
    handleFile(file);
  } catch(err) {
    alert('샘플 로드 실패: ' + (err?.message || String(err)));
  }
}

if(sampleKo) sampleKo.addEventListener('click', () => loadSample('/assets/demo-learning-ko.pdf', 'demo-learning-ko.pdf'));
if(sampleEn) sampleEn.addEventListener('click', () => loadSample('/assets/demo-learning.pdf', 'demo-learning.pdf'));

async function initializeRuntime() {
  initializeAdsenseControls();
  await initializeRuntimeKey();
  await initHealth();
  await refreshDocList({ silent: true });
}

initializeRuntime();

function applyAnalysisResult(data, { announce = true } = {}) {
  resetProgressTimers();
  loader.classList.remove('active');
  setJobStatus('');
  results.style.display = 'block';
  document.getElementById('step1').className = 'done';
  document.getElementById('step1').textContent = 'Document Parse — 완료';
  document.getElementById('step2').className = 'done';
  document.getElementById('step2').textContent = 'Information Extract — 완료';
  document.getElementById('step3').className = 'done';
  document.getElementById('step3').textContent = 'Solar 처리 — 완료';
  document.getElementById('step4').className = 'done';
  document.getElementById('step4').textContent = '교육 콘텐츠 — 완료';
  document.getElementById('ps1').classList.remove('active');
  document.getElementById('ps2').classList.remove('active');
  document.getElementById('ps3').classList.remove('active');
  document.getElementById('ps4').classList.add('active');

  document.getElementById('parsedContent').textContent = data.parsed_markdown || '(empty)';

  const grid = document.getElementById('extractedGrid');
  grid.innerHTML = '';
  if(data.extracted_data && typeof data.extracted_data === 'object') {
    for(const [k, v] of Object.entries(data.extracted_data)) {
      if(k === 'raw') continue;
      grid.innerHTML += `<div class="extracted-item"><div class="key">${k}</div><div class="val">${v || '-'}</div></div>`;
    }
  }

  document.getElementById('summaryText').textContent = data.summary || '';

  const edu = data.edu_pack || {};
  renderList('eduObjectives', edu.learning_objectives, '학습 목표가 없습니다.');
  renderList('eduConcepts', edu.key_concepts, '핵심 개념이 없습니다.');
  document.getElementById('eduSummary').textContent = edu.summary || '교육용 요약이 없습니다.';
  renderQA('eduQuiz', edu.quiz, 'question', 'answer', '퀴즈가 없습니다.');
  renderQA('eduCards', edu.flashcards, 'front', 'back', '플래시카드가 없습니다.');
  renderList('eduActivities', edu.activities, '활동/과제가 없습니다.');

  docReady = true;
  chatInput.disabled = false;
  sendBtn.disabled = false;
  emptyChat.style.display = 'none';
  lastAnalysis = data;
  currentDocId = data.doc_id || 'current';
  setExportEnabled(true);
  if(Array.isArray(data.tags)) {
    tagInput.value = data.tags.join(', ');
  }
  currentRecommendations = getRecommendedTags(data);
  renderTagSuggestions(currentRecommendations);

  if (announce) {
    addMsg('agent', `"${data.filename}" 분석이 완료되었습니다.\n\n${data.summary || ''}\n\n궁금한 점을 질문해주세요!`);
  }
}

async function handleFile(file) {
  // Reset
  resetProgressTimers();
  lastAnalysis = null;
  currentDocId = null;
  activeAnalysisJobId = null;
  setExportEnabled(false);
  docReady = false;
  chatInput.disabled = true;
  sendBtn.disabled = true;
  emptyChat.style.display = 'flex';
  tagInput.value = '';
  currentRecommendations = [];
  renderTagSuggestions([]);
  results.style.display = 'none';
  loader.classList.add('active');
  setJobStatus('');
  if (cancelJobBtn) cancelJobBtn.disabled = true;
  updateProgressFromJob({ status: 'queued', step: 1, progress_label: '분석 작업' });

  dropArea.innerHTML = `<p>${file.name} (${(file.size/1024).toFixed(1)}KB)</p>`;

  const formData = new FormData();
  formData.append('file', file);
  formData.append('audience', audienceSelect.value);
  formData.append('goal', goalSelect.value);
  formData.append('tags', tagInput.value);

  try {
    const created = await apiFetch('/api/analyze/jobs', { method:'POST', body:formData });
    activeAnalysisJobId = created.job_id || null;
    if (cancelJobBtn) cancelJobBtn.disabled = !activeAnalysisJobId;
    if (activeAnalysisJobId) setJobStatus(`작업 ID: ${activeAnalysisJobId}`);
    const data = await waitForAnalysisJob(created.job_id);
    applyAnalysisResult(data, { announce: true });
    await refreshDocList({ silent: true });

  } catch(err) {
    resetProgressTimers();
    loader.classList.remove('active');
    alert('분석 실패: ' + (err?.message || String(err)));
  } finally {
    if (cancelJobBtn) cancelJobBtn.disabled = true;
    activeAnalysisJobId = null;
  }
}

// Chat
sendBtn.addEventListener('click', sendChat);
chatInput.addEventListener('keydown', e => { if(e.key === 'Enter' && !e.shiftKey) sendChat(); });
tagInput.addEventListener('input', () => scheduleTagSync());
exportMarkdown.addEventListener('click', () => {
  if(!lastAnalysis) return;
  const md = createMarkdownExport(lastAnalysis);
  const base = safeFilename(lastAnalysis.filename || 'docuagent');
  downloadFile(md, `${base}.md`, 'text/markdown');
});
exportHtml.addEventListener('click', () => {
  if(!lastAnalysis) return;
  const html = createHtmlExport(lastAnalysis);
  const base = safeFilename(lastAnalysis.filename || 'docuagent');
  downloadFile(html, `${base}.html`, 'text/html');
});
exportPdf.addEventListener('click', () => {
  if(!lastAnalysis) return;
  const html = createHtmlExport(lastAnalysis, true);
  openPrintWindow(html);
});
exportScorm.addEventListener('click', async () => {
  if(!lastAnalysis) return;
  const base = safeFilename(lastAnalysis.filename || 'docuagent');
  const doc = encodeURIComponent(currentDocId || 'current');
  await downloadFromApi(`/api/export/scorm?doc_id=${doc}`, `${base}_scorm.zip`);
});
exportIms.addEventListener('click', async () => {
  if(!lastAnalysis) return;
  const base = safeFilename(lastAnalysis.filename || 'docuagent');
  const doc = encodeURIComponent(currentDocId || 'current');
  await downloadFromApi(`/api/export/ims?doc_id=${doc}`, `${base}_imscc.zip`);
});
exportScorm2004.addEventListener('click', async () => {
  if(!lastAnalysis) return;
  const base = safeFilename(lastAnalysis.filename || 'docuagent');
  const doc = encodeURIComponent(currentDocId || 'current');
  await downloadFromApi(`/api/export/scorm2004?doc_id=${doc}`, `${base}_scorm2004.zip`);
});
exportIms13.addEventListener('click', async () => {
  if(!lastAnalysis) return;
  const base = safeFilename(lastAnalysis.filename || 'docuagent');
  const doc = encodeURIComponent(currentDocId || 'current');
  await downloadFromApi(`/api/export/ims13?doc_id=${doc}`, `${base}_imscc13.zip`);
});

async function sendChat() {
  const q = chatInput.value.trim();
  if(!q || !docReady) return;

  chatInput.value = '';
  addMsg('user', q);
  sendBtn.disabled = true;

  const thinkMsg = addMsg('agent', '분석 중...');

  try {
    const formData = new FormData();
    formData.append('question', q);
    formData.append('doc_id', currentDocId || 'current');

    const data = await apiFetch('/api/chat', { method:'POST', body:formData });
    thinkMsg.querySelector('.content').textContent = data.answer;
  } catch(err) {
    thinkMsg.querySelector('.content').textContent = '오류가 발생했습니다: ' + (err?.message || String(err));
  }

  sendBtn.disabled = false;
  chatInput.focus();
}

function renderList(elId, items, emptyText) {
  const el = document.getElementById(elId);
  el.innerHTML = '';
  if(!Array.isArray(items) || items.length === 0) {
    const li = document.createElement('li');
    li.textContent = emptyText || '내용이 없습니다.';
    el.appendChild(li);
    return;
  }
  items.forEach(item => {
    const li = document.createElement('li');
    li.textContent = item;
    el.appendChild(li);
  });
}

function renderQA(elId, items, qKey, aKey, emptyText) {
  const el = document.getElementById(elId);
  el.innerHTML = '';
  if(!Array.isArray(items) || items.length === 0) {
    const div = document.createElement('div');
    div.className = 'qa-item';
    div.textContent = emptyText || '내용이 없습니다.';
    el.appendChild(div);
    return;
  }
  items.forEach((item, idx) => {
    const qa = document.createElement('div');
    qa.className = 'qa-item';
    const q = document.createElement('div');
    q.className = 'qa-q';
    q.textContent = `Q${idx + 1}. ${item?.[qKey] || ''}`;
    const a = document.createElement('div');
    a.className = 'qa-a';
    a.textContent = item?.[aKey] ? `A. ${item[aKey]}` : '';
    qa.appendChild(q);
    qa.appendChild(a);
    el.appendChild(qa);
  });
}

function parseTagInput(text) {
  return text
    .split(/[,\n]/)
    .map(t => t.replace(/#/g, '').trim())
    .filter(Boolean)
    .filter((v, i, arr) => arr.indexOf(v) === i)
    .slice(0, 12);
}

function scheduleTagSync() {
  if(tagSyncTimer) clearTimeout(tagSyncTimer);
  tagSyncTimer = setTimeout(() => syncTags(), 500);
  renderTagSuggestions(currentRecommendations);
}

async function syncTags() {
  if(!lastAnalysis) return;
  const tags = parseTagInput(tagInput.value);
  tagInput.value = tags.join(', ');
  const formData = new FormData();
  formData.append('doc_id', currentDocId || 'current');
  formData.append('tags', tags.join(','));
  try {
    const data = await apiFetch('/api/update-tags', { method:'POST', body:formData });
    lastAnalysis.tags = data.tags || tags;
  } catch {
    // ignore
  }
}

function renderTagSuggestions(tags) {
  tagSuggestions.innerHTML = '';
  if(!tags || tags.length === 0) {
    const empty = document.createElement('span');
    empty.className = 'tag-label';
    empty.textContent = '추천 없음';
    tagSuggestions.appendChild(empty);
    return;
  }
  const selected = parseTagInput(tagInput.value);
  tags.forEach(tag => {
    const chip = document.createElement('button');
    chip.type = 'button';
    chip.className = 'tag-chip' + (selected.includes(tag) ? ' active' : '');
    chip.textContent = tag;
    chip.addEventListener('click', () => {
      const current = parseTagInput(tagInput.value);
      if(current.includes(tag)) {
        const next = current.filter(t => t !== tag);
        tagInput.value = next.join(', ');
      } else {
        current.push(tag);
        tagInput.value = current.join(', ');
      }
      renderTagSuggestions(currentRecommendations);
      scheduleTagSync();
    });
    tagSuggestions.appendChild(chip);
  });
}

function getRecommendedTags(data) {
  const tags = [];
  const edu = data.edu_pack || {};
  (edu.key_concepts || []).slice(0, 6).forEach(t => tags.push(String(t)));
  const extracted = data.extracted_data || {};
  if(extracted && typeof extracted === 'object') {
    const docType = extracted.document_type || extracted.doc_type;
    if(docType) tags.push(String(docType));
    const title = extracted.title;
    if(title && String(title).length <= 40) tags.push(String(title));
  }
  return tags.filter((v, i, arr) => v && arr.indexOf(v) === i).slice(0, 10);
}

function safeFilename(name) {
  return name.replace(/\.[^/.]+$/, '').replace(/[^\w.-]+/g, '_').slice(0, 60) || 'docuagent';
}

function formatValue(val) {
  if(val === null || val === undefined) return '-';
  if(typeof val === 'string') return val;
  try {
    return JSON.stringify(val);
  } catch {
    return String(val);
  }
}

function escapeHtml(text) {
  return String(text || '')
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#39;');
}

function createMarkdownExport(data) {
  const edu = data.edu_pack || {};
  const lines = [];
  lines.push(`# ${data.filename || 'DocuAgent 결과'}`);
  lines.push('');
  lines.push(`- 파일명: ${data.filename || '-'}`);
  lines.push(`- 페이지 수: ${data.pages ?? '-'}`);
  lines.push(`- 학습자 수준: ${data.audience || '-'}`);
  lines.push(`- 학습 목표: ${data.goal || '-'}`);
  lines.push(`- 태그: ${(data.tags && data.tags.length) ? data.tags.join(', ') : '-'}`);
  lines.push(`- 생성일: ${new Date().toISOString()}`);
  lines.push('');
  lines.push('## 요약');
  lines.push(data.summary || '-');
  lines.push('');
  lines.push('## 추출 정보');
  if(data.extracted_data && typeof data.extracted_data === 'object') {
    for(const [k, v] of Object.entries(data.extracted_data)) {
      if(k === 'raw') continue;
      lines.push(`- ${k}: ${formatValue(v)}`);
    }
  } else {
    lines.push('- 없음');
  }
  lines.push('');
  lines.push('## 교육 콘텐츠');
  lines.push('### 학습 목표');
  (edu.learning_objectives || []).forEach(v => lines.push(`- ${v}`));
  if(!edu.learning_objectives || edu.learning_objectives.length === 0) lines.push('- 없음');
  lines.push('');
  lines.push('### 핵심 개념');
  (edu.key_concepts || []).forEach(v => lines.push(`- ${v}`));
  if(!edu.key_concepts || edu.key_concepts.length === 0) lines.push('- 없음');
  lines.push('');
  lines.push('### 교육용 요약');
  lines.push(edu.summary || '-');
  lines.push('');
  lines.push('### 퀴즈');
  if(Array.isArray(edu.quiz) && edu.quiz.length) {
    edu.quiz.forEach((q, i) => {
      lines.push(`${i + 1}. Q: ${q.question || ''}`);
      lines.push(`   A: ${q.answer || ''}`);
    });
  } else {
    lines.push('- 없음');
  }
  lines.push('');
  lines.push('### 플래시카드');
  if(Array.isArray(edu.flashcards) && edu.flashcards.length) {
    edu.flashcards.forEach((c, i) => {
      lines.push(`${i + 1}. Front: ${c.front || ''}`);
      lines.push(`   Back: ${c.back || ''}`);
    });
  } else {
    lines.push('- 없음');
  }
  lines.push('');
  lines.push('### 활동/과제');
  (edu.activities || []).forEach(v => lines.push(`- ${v}`));
  if(!edu.activities || edu.activities.length === 0) lines.push('- 없음');
  lines.push('');
  lines.push('## 원문 파싱');
  lines.push(data.parsed_markdown || '-');
  return lines.join('\n');
}

function createHtmlExport(data, forPrint = false) {
  const edu = data.edu_pack || {};
  const styles = `
    body{font-family:Arial, sans-serif; line-height:1.6; padding:32px; color:#111;}
    h1,h2,h3{margin:0 0 12px;}
    h2{margin-top:26px; border-bottom:1px solid #ddd; padding-bottom:6px;}
    .meta{font-size:12px; color:#555;}
    .card{background:#f8f8fb; border:1px solid #e6e6ee; padding:12px 14px; border-radius:8px;}
    .qa{margin:8px 0; padding:8px 10px; border:1px solid #e3e3ee; border-radius:8px;}
    .muted{color:#666;}
    @media print{body{padding:0;} h1{margin-top:0;} }
  `;
  const listItems = (items) => items && items.length ? items.map(i => `<li>${escapeHtml(i)}</li>`).join('') : '<li>없음</li>';
  const qaItems = (items, qKey, aKey) => items && items.length
    ? items.map((q, i) => `<div class="qa"><strong>Q${i + 1}.</strong> ${escapeHtml(q?.[qKey] || '')}<br><span class="muted">A.</span> ${escapeHtml(q?.[aKey] || '')}</div>`).join('')
    : '<div class="qa">없음</div>';
  const extracted = data.extracted_data && typeof data.extracted_data === 'object'
    ? Object.entries(data.extracted_data).filter(([k]) => k !== 'raw').map(([k, v]) => `<li><strong>${escapeHtml(k)}:</strong> ${escapeHtml(formatValue(v))}</li>`).join('')
    : '<li>없음</li>';
  const title = escapeHtml(data.filename || 'DocuAgent 결과');
  return `<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>${title}</title>
  <style>${styles}</style>
</head>
<body>
  <h1>${title}</h1>
  <div class="meta">
    <div>페이지 수: ${escapeHtml(data.pages ?? '-')}</div>
    <div>학습자 수준: ${escapeHtml(data.audience || '-')}</div>
    <div>학습 목표: ${escapeHtml(data.goal || '-')}</div>
    <div>태그: ${escapeHtml((data.tags && data.tags.length) ? data.tags.join(', ') : '-')}</div>
    <div>생성일: ${new Date().toISOString()}</div>
  </div>

  <h2>요약</h2>
  <div class="card">${escapeHtml(data.summary || '-')}</div>

  <h2>추출 정보</h2>
  <ul>${extracted}</ul>

  <h2>교육 콘텐츠</h2>
  <h3>학습 목표</h3>
  <ul>${listItems(edu.learning_objectives || [])}</ul>
  <h3>핵심 개념</h3>
  <ul>${listItems(edu.key_concepts || [])}</ul>
  <h3>교육용 요약</h3>
  <div class="card">${escapeHtml(edu.summary || '-')}</div>
  <h3>퀴즈</h3>
  ${qaItems(edu.quiz || [], 'question', 'answer')}
  <h3>플래시카드</h3>
  ${qaItems(edu.flashcards || [], 'front', 'back')}
  <h3>활동/과제</h3>
  <ul>${listItems(edu.activities || [])}</ul>

  <h2>원문 파싱</h2>
  <div class="card"><pre>${escapeHtml(data.parsed_markdown || '-')}</pre></div>

<script defer src="./analytics.js"></script>
</body>
</html>`;
}

function downloadFile(content, filename, mime) {
  const blob = new Blob([content], { type: mime });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

function openPrintWindow(html) {
  const win = window.open('', '_blank', 'width=900,height=1200');
  if(!win) return alert('팝업이 차단되었습니다. 팝업을 허용해 주세요.');
  win.document.open();
  win.document.write(html);
  win.document.close();
  win.focus();
  win.onload = () => win.print();
}

async function downloadFromApi(url, filename) {
  try {
    const resp = await fetch(url);
    if(!resp.ok) {
      const data = await resp.json().catch(() => ({}));
      throw new Error(apiErrorMessage(data, '다운로드 실패'));
    }
    const blob = await resp.blob();
    const a = document.createElement('a');
    const blobUrl = URL.createObjectURL(blob);
    a.href = blobUrl;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(blobUrl);
  } catch (err) {
    alert((err && err.message) || '다운로드 중 오류가 발생했습니다.');
  }
}

function addMsg(role, text) {
  const div = document.createElement('div');
  div.className = `msg ${role}`;
  const sender = role === 'agent' ? 'DocuAgent' : '나';
  div.innerHTML = `<div class="sender">${sender}</div><div class="content">${text.replace(/\n/g,'<br>')}</div>`;
  chatMessages.appendChild(div);
  chatMessages.scrollTop = chatMessages.scrollHeight;
  return div;
}
</script>
</body>
</html>
